<%-# Fedena
#Copyright 2010 Foradian Technologies Private Limited
#
#This product includes software developed at
#Project Fedena - http://www.projectfedena.org/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<!doctype html>
<%= render 'shared/ie' %>
	<head>
		<title>Login</title>
		<%= render 'shared/global_head' %>
				
		<%= stylesheet_link_tag 'special-pages' %>
	</head>
	<!-- the 'special-page' class is only an identifier for scripts -->
	<body class="special-page login-bg dark">
	
		<section id="message">
			<% if flash.empty? %>
			<div class="block-border"><div class="block-content no-title dark-bg">
				<p class="mini-infos">Please contact school for <b>new user account</b></p>
			</div></div>
			<% else %>
			<div class="block-border"><div class="block-content no-title dark-bg">
				<p class="mini-infos"><%= flash[:notice] %></p>
			</div></div>
			<% end %>
		</section>
		
		<section id="login-block">
			<div class="block-border"><div class="block-content">
				
				<!--
				IE7 compatibility: if you want to remove the <h1>, 
				add style="zoom:1" to the above .block-content div
				-->
				<h1>Login</h1>
				<!--
					TODO: Move name of the school to some variable
				-->
				<div class="block-header">Mount Carmel School</div>
				
				<!-- 
				<% if !flash.empty? %>	
				<p class="message error no-margin"><%= flash[:notice] %></p>
				<% end %>
				-->
				
				<%= form_for :user, :html => { :class => "form with-margin", :id => "login-form"} do |form| %>
					<p class="inline-small-label">
						<label for="username"><span class="big">User name</span></label>
						 <%= form.text_field :username, :class => "full-width", :maxlength => 40  %>
					</p>
					<p class="inline-small-label">
						<label for="password"><span class="big">Password</span></label>
						<%= form.password_field :password, :class => "full-width" %>
					</p>
					
					<%= submit_tag "Login", :class => "float-right" %>
					<p class="input-height">
						<input type="checkbox" name="remember" id="remember" value="1" class="mini-switch" checked="checked">
						<label for="remember" class="inline">Keep me logged in</label>
					</p>
					
				<% end %>
				<form class="form" id="password-recovery" method="post" action="">
					<fieldset class="grey-bg no-margin collapse">
						<legend><a href="#">Lost password?</a></legend>
						<p class="input-with-button">
							<label for="recovery-mail">Enter your e-mail address</label>
							<input type="text" name="recovery-mail" id="recovery-mail" value="">
							<button type="button">Send</button>
						</p>
					</fieldset>
				</form>
			</div></div>
		</section>
		
		<%= render 'shared/js' %>
		
		<!-- example login script -->
		<script>
		
			$(document).ready(function() {
				// We'll catch form submission to do it in AJAX, but this works also with JS disabled
				$('#login-form').submit(function(event)	{
					// Stop full page load
					event.preventDefault();
					
					// Check fields
					var login = $('#user_username').val();
					var pass = $('#user_password').val();
					
					if (!login || login.length == 0) {
						$('#login-block').removeBlockMessages().blockMessage('Please enter your user name', {type: 'warning'});
					}
					else if (!pass || pass.length == 0) {
						$('#login-block').removeBlockMessages().blockMessage('Please enter your password', {type: 'warning'});
					}
					else {
						var submitBt = $(this).find('button[type=submit]');
						submitBt.disableBt();
						
						// Target url
						var target = $(this).attr('action');
						if (!target || target == '') {
							// Page url without hash
							target = document.location.href.match(/^([^#]+)/)[1];
						}
						
						// Request
						var data = {
							'user[username]' : login,
							'user[password]': pass,
							remember: $('#remember').attr('checked') ? 1 : 0
						}
						// redirect = $('#redirect'),
						sendTimer = new Date().getTime();
						
						// if (redirect.length > 0) {
							// data.redirect = redirect.val();
						// }
						
						// Send
						$.ajax({
							url: target,
							dataType: 'json',
							type: 'POST',
							data: data,
							success: function(data, textStatus, jqXHR)	{
								if (data.valid) {
									// Small timer to allow the 'cheking login' message to show when server is too fast
									var receiveTimer = new Date().getTime();
									if (receiveTimer-sendTimer < 500) {
										setTimeout(function() {
											document.location.href = data.redirect;											
										}, 500-(receiveTimer-sendTimer));
									}
									else {
										document.location.href = data.redirect;
									}
								}
								else {
									// Message
									$('#login-block').removeBlockMessages().blockMessage(data.error || 'An unexpected error occured, please try again', {type: 'error'});
									submitBt.enableBt();
								}
							},
							error: function(jqXHR, textStatus, errorThrown) {
								// Message
								$('#login-block').removeBlockMessages().blockMessage('Error while contacting server, please try again', {type: 'error'});
								submitBt.enableBt();
							}
						});
						
						// Message
						$('#login-block').removeBlockMessages().blockMessage('Please wait, cheking login...', {type: 'loading'});
					}
				});
			});
		
		</script>
		
	</body>
</html>